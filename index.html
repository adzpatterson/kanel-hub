<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanel Supply Chain Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0c;
            --surface: #141418;
            --surface-2: #1c1c22;
            --border: #2a2a32;
            --text: #e8e8ec;
            --text-muted: #8b8b96;
            --accent: #d4a853;
            --accent-dim: #d4a85320;
            --red: #e54d4d;
            --red-bg: #e54d4d15;
            --orange: #e8923a;
            --orange-bg: #e8923a15;
            --blue: #4d9ee5;
            --blue-bg: #4d9ee515;
            --green: #4dc77a;
            --green-bg: #4dc77a15;
            --gray: #555;
            --gray-bg: #55555515;
            --radius: 10px;
            --font: 'DM Sans', -apple-system, sans-serif;
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ---- HEADER ---- */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .logo {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            color: var(--accent);
            text-transform: uppercase;
        }
        .logo-sub {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--accent-dim);
            border: 1px solid var(--accent);
            color: var(--accent);
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .refresh-btn:hover { background: var(--accent); color: var(--bg); }
        .refresh-btn.loading { opacity: 0.6; pointer-events: none; }
        .refresh-btn svg { width: 14px; height: 14px; }
        .refresh-btn.loading svg { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .last-updated {
            font-size: 12px;
            color: var(--text-muted);
            font-family: var(--mono);
        }

        /* ---- SETUP SCREEN ---- */
        .setup-screen {
            max-width: 480px;
            margin: 80px auto;
            padding: 40px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        .setup-screen h2 {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 18px;
        }
        .setup-screen p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 24px;
        }
        .setup-screen label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .setup-screen input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: var(--mono);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .setup-screen input:focus { outline: none; border-color: var(--accent); }
        .setup-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 6px;
            font-family: var(--font);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 8px;
        }
        .setup-btn:hover { opacity: 0.9; }
        .setup-error {
            color: var(--red);
            font-size: 13px;
            margin-top: 12px;
            display: none;
        }

        /* ---- NAV TABS ---- */
        .nav {
            display: flex;
            gap: 0;
            padding: 0 32px;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        .nav-tab {
            padding: 14px 20px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .nav-tab:hover { color: var(--text); }
        .nav-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        /* ---- MAIN CONTENT ---- */
        .main { padding: 24px 32px; }
        .hidden { display: none !important; }

        /* ---- SUMMARY CARDS ---- */
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
        }
        .card-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .card-value {
            font-size: 28px;
            font-weight: 700;
            font-family: var(--mono);
        }
        .card-value.red { color: var(--red); }
        .card-value.orange { color: var(--orange); }
        .card-value.blue { color: var(--blue); }
        .card-value.green { color: var(--green); }
        .card-value.gray { color: var(--gray); }

        /* ---- FILTERS ---- */
        .filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            font-family: var(--font);
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .filter-btn:hover { border-color: var(--text-muted); color: var(--text); }
        .filter-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .filter-btn .count {
            font-family: var(--mono);
            font-size: 11px;
            margin-left: 4px;
            opacity: 0.7;
        }

        .search-input {
            padding: 6px 14px;
            font-size: 13px;
            font-family: var(--font);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            width: 240px;
        }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .search-input::placeholder { color: var(--text-muted); }

        /* ---- TABLE ---- */
        .table-wrap {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .table-scroll { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead th {
            position: sticky;
            top: 0;
            background: var(--surface-2);
            padding: 10px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        thead th:hover { color: var(--text); }
        thead th.sorted-asc::after { content: ' \u2191'; color: var(--accent); }
        thead th.sorted-desc::after { content: ' \u2193'; color: var(--accent); }
        tbody td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }
        tbody tr:hover { background: var(--surface-2); }
        tbody tr:last-child td { border-bottom: none; }
        .num { font-family: var(--mono); text-align: right; }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .badge-oos { background: var(--gray-bg); color: #999; border: 1px solid #44444480; }
        .badge-critical { background: var(--red-bg); color: var(--red); border: 1px solid #e54d4d40; }
        .badge-atrisk { background: var(--orange-bg); color: var(--orange); border: 1px solid #e8923a40; }
        .badge-healthy { background: var(--blue-bg); color: var(--blue); border: 1px solid #4d9ee540; }
        .badge-excess { background: var(--green-bg); color: var(--green); border: 1px solid #4dc77a40; }

        .bar-cell { width: 120px; }
        .woh-bar {
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            overflow: hidden;
            margin-top: 4px;
        }
        .woh-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

        /* ---- EXPORT ---- */
        .export-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .export-btn {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 600;
            font-family: var(--font);
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
        }
        .export-btn:hover { border-color: var(--accent); color: var(--accent); }

        .result-count {
            font-size: 12px;
            color: var(--text-muted);
            font-family: var(--mono);
        }

        /* ---- PO TAB ---- */
        .po-vendor { color: var(--accent); font-weight: 500; }

        /* ---- LOADING ---- */
        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 0;
            color: var(--text-muted);
            gap: 16px;
        }
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ---- RESPONSIVE ---- */
        @media (max-width: 768px) {
            .header { padding: 16px; }
            .nav { padding: 0 16px; }
            .main { padding: 16px; }
            .cards { grid-template-columns: repeat(2, 1fr); }
            .search-input { width: 100%; }
        }
    </style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setupScreen" class="setup-screen">
    <h2>Kanel Supply Chain Hub</h2>
    <p>Make sure the proxy is running on your computer.<br>Open a terminal and run: <code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-family:var(--mono);">node proxy.js</code></p>
    <label>Proxy URL</label>
    <input type="text" id="setupUrl" value="http://localhost:3847" placeholder="http://localhost:3847">
    <button class="setup-btn" onclick="saveConfig()">Connect</button>
    <div id="setupError" class="setup-error"></div>
</div>

<!-- MAIN APP (hidden until configured) -->
<div id="app" class="hidden">
    <div class="header">
        <div class="header-left">
            <div>
                <div class="logo">Kanel</div>
                <div class="logo-sub">Supply Chain Hub</div>
            </div>
        </div>
        <div class="header-right">
            <span class="last-updated" id="lastUpdated"></span>
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                Refresh
            </button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-tab active" data-tab="woh" onclick="switchTab('woh')">Weeks on Hand</div>
        <div class="nav-tab" data-tab="fg" onclick="switchTab('fg')">Finished Goods</div>
        <div class="nav-tab" data-tab="rm" onclick="switchTab('rm')">Raw Materials</div>
        <div class="nav-tab" data-tab="pos" onclick="switchTab('pos')">Open POs</div>
        <div class="nav-tab" data-tab="boms" onclick="switchTab('boms')">BOMs</div>
    </div>

    <div class="main">
        <!-- WOH TAB -->
        <div id="tab-woh" class="tab-content">
            <div class="cards" id="wohCards"></div>
            <div class="filters" id="wohFilters"></div>
            <div class="export-bar">
                <span class="result-count" id="wohCount"></span>
                <button class="export-btn" onclick="exportCSV('woh')">Export CSV</button>
            </div>
            <div class="table-wrap">
                <div class="table-scroll">
                    <table id="wohTable">
                        <thead>
                            <tr>
                                <th data-col="part_number" onclick="sortTable('woh','part_number')">SKU</th>
                                <th data-col="item_class" onclick="sortTable('woh','item_class')">Type</th>
                                <th data-col="on_hand_qty" onclick="sortTable('woh','on_hand_qty')">On Hand</th>
                                <th data-col="committed_qty" onclick="sortTable('woh','committed_qty')">Committed</th>
                                <th data-col="available_qty" onclick="sortTable('woh','available_qty')">Available</th>
                                <th data-col="weekly_forecast" onclick="sortTable('woh','weekly_forecast')">Weekly Fcst</th>
                                <th data-col="woh" onclick="sortTable('woh','woh')">WOH</th>
                                <th>WOH</th>
                                <th data-col="status" onclick="sortTable('woh','status')">Status</th>
                            </tr>
                        </thead>
                        <tbody id="wohBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FG TAB -->
        <div id="tab-fg" class="tab-content hidden">
            <div class="cards" id="fgCards"></div>
            <div class="filters">
                <input type="text" class="search-input" placeholder="Search finished goods..." oninput="filterFG(this.value)">
            </div>
            <div class="export-bar">
                <span class="result-count" id="fgCount"></span>
                <button class="export-btn" onclick="exportCSV('fg')">Export CSV</button>
            </div>
            <div class="table-wrap">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('fg','part_number')">SKU</th>
                                <th onclick="sortTable('fg','on_hand_qty')">On Hand</th>
                                <th onclick="sortTable('fg','component_count')">Components</th>
                            </tr>
                        </thead>
                        <tbody id="fgBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- RM TAB -->
        <div id="tab-rm" class="tab-content hidden">
            <div class="filters">
                <input type="text" class="search-input" placeholder="Search raw materials..." oninput="filterRM(this.value)">
            </div>
            <div class="export-bar">
                <span class="result-count" id="rmCount"></span>
                <button class="export-btn" onclick="exportCSV('rm')">Export CSV</button>
            </div>
            <div class="table-wrap">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('rm','part_number')">Material</th>
                                <th onclick="sortTable('rm','on_hand_qty')">On Hand</th>
                                <th onclick="sortTable('rm','used_in_count')">Used In</th>
                            </tr>
                        </thead>
                        <tbody id="rmBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- POs TAB -->
        <div id="tab-pos" class="tab-content hidden">
            <div class="cards" id="poCards"></div>
            <div class="filters">
                <input type="text" class="search-input" placeholder="Search POs, vendors, parts..." oninput="filterPOs(this.value)">
            </div>
            <div class="export-bar">
                <span class="result-count" id="poCount"></span>
                <button class="export-btn" onclick="exportCSV('pos')">Export CSV</button>
            </div>
            <div class="table-wrap">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('pos','po_num')">PO #</th>
                                <th onclick="sortTable('pos','vendor')">Vendor</th>
                                <th onclick="sortTable('pos','part')">Part</th>
                                <th onclick="sortTable('pos','qty_remaining')">Qty Remaining</th>
                                <th onclick="sortTable('pos','expected_date')">Expected</th>
                                <th onclick="sortTable('pos','status')">Status</th>
                            </tr>
                        </thead>
                        <tbody id="poBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BOMs TAB -->
        <div id="tab-boms" class="tab-content hidden">
            <div class="filters">
                <input type="text" class="search-input" placeholder="Search BOMs..." oninput="filterBOMs(this.value)">
            </div>
            <div class="export-bar">
                <span class="result-count" id="bomCount"></span>
                <button class="export-btn" onclick="exportCSV('boms')">Export CSV</button>
            </div>
            <div class="table-wrap">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('boms','finished_good')">Finished Good</th>
                                <th onclick="sortTable('boms','component')">Component</th>
                                <th onclick="sortTable('boms','qty_per')">Qty Per</th>
                                <th onclick="sortTable('boms','uom')">UOM</th>
                            </tr>
                        </thead>
                        <tbody id="bomBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let appState = {
    config: null,
    data: null,
    wohFilter: 'all',
    wohSearch: '',
    sortCol: {},
    sortDir: {},
    forecast: {},  // user-uploaded forecast data
};

// ============================================================
// CONFIG / SETUP
// ============================================================
function loadConfig() {
    const saved = localStorage.getItem('kanel-hub-config');
    if (saved) {
        appState.config = JSON.parse(saved);
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        // Load any saved forecast
        const fc = localStorage.getItem('kanel-hub-forecast');
        if (fc) appState.forecast = JSON.parse(fc);
        refreshData();
    }
}

async function saveConfig() {
    const url = document.getElementById('setupUrl').value.trim().replace(/\/$/, '');
    const errEl = document.getElementById('setupError');

    if (!url) {
        errEl.textContent = 'URL is required.';
        errEl.style.display = 'block';
        return;
    }

    errEl.textContent = 'Testing connection...';
    errEl.style.display = 'block';
    errEl.style.color = 'var(--text-muted)';

    try {
        const resp = await fetch(`${url}/api/health`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (data.status !== 'ok') throw new Error('Unexpected response');

        appState.config = { url, key: '' };
        localStorage.setItem('kanel-hub-config', JSON.stringify(appState.config));
        document.getElementById('setupScreen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        refreshData();
    } catch (e) {
        errEl.style.color = 'var(--red)';
        errEl.textContent = `Connection failed: ${e.message}. Is the proxy running? (node proxy.js)`;
    }
}

// ============================================================
// DATA FETCHING
// ============================================================
async function refreshData() {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('loading');
    btn.querySelector('svg').style.animation = 'spin 1s linear infinite';

    try {
        const resp = await fetch(`${appState.config.url}/api/woh`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        appState.data = await resp.json();

        document.getElementById('lastUpdated').textContent =
            `Updated ${new Date(appState.data.timestamp).toLocaleString('en-CA', {
                month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            })}`;

        renderAll();
    } catch (e) {
        console.error('Refresh failed:', e);
        alert('Failed to refresh data. Check your connection.');
    } finally {
        btn.classList.remove('loading');
    }
}

// ============================================================
// WOH CALCULATION
// ============================================================
function calculateWOH(inventory) {
    // For each item, calculate weeks on hand
    // WOH = on_hand_qty / weekly_forecast
    // If no forecast uploaded, we show OH only and prompt for forecast
    return inventory.map(item => {
        const fc = appState.forecast[item.part_number];
        const weeklyFcst = fc ? fc / 52 : null;
        const available = item.available_qty !== undefined ? item.available_qty : item.on_hand_qty;
        let woh = null;
        let status = 'no-forecast';

        if (weeklyFcst && weeklyFcst > 0) {
            woh = available / weeklyFcst;
            if (available === 0) status = 'oos';
            else if (woh < 4) status = 'critical';
            else if (woh < 8) status = 'atrisk';
            else if (woh <= 20) status = 'healthy';
            else status = 'excess';
        } else if (available === 0) {
            status = 'oos';
            woh = 0;
        }

        return { ...item, available_qty: available, weekly_forecast: weeklyFcst, woh, status };
    });
}

function getStatusLabel(s) {
    const map = {
        'oos': 'Out of Stock',
        'critical': 'Critical',
        'atrisk': 'At Risk',
        'healthy': 'Healthy',
        'excess': 'Excess',
        'no-forecast': 'No Forecast'
    };
    return map[s] || s;
}

function getStatusBadge(s) {
    const cls = {
        'oos': 'badge-oos',
        'critical': 'badge-critical',
        'atrisk': 'badge-atrisk',
        'healthy': 'badge-healthy',
        'excess': 'badge-excess',
        'no-forecast': 'badge-oos'
    };
    return `<span class="badge ${cls[s] || ''}">${getStatusLabel(s)}</span>`;
}

function getBarColor(s) {
    const map = {
        'oos': '#555',
        'critical': 'var(--red)',
        'atrisk': 'var(--orange)',
        'healthy': 'var(--blue)',
        'excess': 'var(--green)',
        'no-forecast': '#333'
    };
    return map[s] || '#333';
}

// ============================================================
// RENDERING
// ============================================================
function renderAll() {
    if (!appState.data) return;
    renderWOH();
    renderFG();
    renderRM();
    renderPOs();
    renderBOMs();
}

function renderWOH() {
    const inv = appState.data.inventory || [];
    const wohData = calculateWOH(inv);

    // Summary cards
    const counts = { oos: 0, critical: 0, atrisk: 0, healthy: 0, excess: 0 };
    wohData.forEach(r => { if (counts[r.status] !== undefined) counts[r.status]++; });

    document.getElementById('wohCards').innerHTML = `
        <div class="card"><div class="card-label">Total SKUs</div><div class="card-value">${inv.length}</div></div>
        <div class="card"><div class="card-label">Out of Stock</div><div class="card-value gray">${counts.oos}</div></div>
        <div class="card"><div class="card-label">Critical (&lt;4 wk)</div><div class="card-value red">${counts.critical}</div></div>
        <div class="card"><div class="card-label">At Risk (4-8 wk)</div><div class="card-value orange">${counts.atrisk}</div></div>
        <div class="card"><div class="card-label">Healthy (8-20 wk)</div><div class="card-value blue">${counts.healthy}</div></div>
        <div class="card"><div class="card-label">Excess (&gt;20 wk)</div><div class="card-value green">${counts.excess}</div></div>
    `;

    // Filter buttons
    const hasForecast = Object.keys(appState.forecast).length > 0;
    document.getElementById('wohFilters').innerHTML = `
        <button class="filter-btn ${appState.wohFilter === 'all' ? 'active' : ''}" onclick="setWohFilter('all')">All<span class="count">${inv.length}</span></button>
        <button class="filter-btn ${appState.wohFilter === 'oos' ? 'active' : ''}" onclick="setWohFilter('oos')">OOS<span class="count">${counts.oos}</span></button>
        <button class="filter-btn ${appState.wohFilter === 'critical' ? 'active' : ''}" onclick="setWohFilter('critical')">Critical<span class="count">${counts.critical}</span></button>
        <button class="filter-btn ${appState.wohFilter === 'atrisk' ? 'active' : ''}" onclick="setWohFilter('atrisk')">At Risk<span class="count">${counts.atrisk}</span></button>
        <button class="filter-btn ${appState.wohFilter === 'healthy' ? 'active' : ''}" onclick="setWohFilter('healthy')">Healthy<span class="count">${counts.healthy}</span></button>
        <button class="filter-btn ${appState.wohFilter === 'excess' ? 'active' : ''}" onclick="setWohFilter('excess')">Excess<span class="count">${counts.excess}</span></button>
        <input type="text" class="search-input" placeholder="Search SKUs..." oninput="appState.wohSearch=this.value; renderWOHTable()" value="${appState.wohSearch}">
        ${!hasForecast ? '<button class="filter-btn" style="border-color:var(--accent);color:var(--accent);" onclick="showForecastUpload()">+ Upload Forecast</button>' : '<button class="filter-btn" onclick="showForecastUpload()">Update Forecast</button>'}
    `;

    renderWOHTable(wohData);
}

function renderWOHTable(wohData) {
    if (!wohData) {
        wohData = calculateWOH(appState.data.inventory || []);
    }

    let filtered = wohData;
    if (appState.wohFilter !== 'all') {
        filtered = filtered.filter(r => r.status === appState.wohFilter);
    }
    if (appState.wohSearch) {
        const q = appState.wohSearch.toLowerCase();
        filtered = filtered.filter(r => r.part_number.toLowerCase().includes(q));
    }

    // Sort
    const col = appState.sortCol['woh'];
    const dir = appState.sortDir['woh'] || 'asc';
    if (col) {
        filtered.sort((a, b) => {
            let va = a[col], vb = b[col];
            if (va === null) va = col === 'woh' ? 99999 : '';
            if (vb === null) vb = col === 'woh' ? 99999 : '';
            if (typeof va === 'string') return dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
            return dir === 'asc' ? va - vb : vb - va;
        });
    }

    document.getElementById('wohCount').textContent = `${filtered.length} items`;

    const maxWoh = 30;
    document.getElementById('wohBody').innerHTML = filtered.map(r => {
        const barW = r.woh !== null ? Math.min(r.woh / maxWoh * 100, 100) : 0;
        return `<tr>
            <td>${r.part_number}</td>
            <td><span style="font-size:11px;color:var(--text-muted)">${r.item_class}</span></td>
            <td class="num">${formatNum(r.on_hand_qty)}</td>
            <td class="num" style="color:${r.committed_qty > 0 ? 'var(--orange)' : 'var(--text-muted)'}">${formatNum(r.committed_qty || 0)}</td>
            <td class="num" style="font-weight:600">${formatNum(r.available_qty)}</td>
            <td class="num">${r.weekly_forecast !== null ? formatNum(r.weekly_forecast, 1) : '<span style="color:var(--text-muted)">--</span>'}</td>
            <td class="num" style="font-weight:600">${r.woh !== null ? formatNum(r.woh, 1) : '--'}</td>
            <td class="bar-cell"><div class="woh-bar"><div class="woh-bar-fill" style="width:${barW}%;background:${getBarColor(r.status)}"></div></div></td>
            <td>${getStatusBadge(r.status)}</td>
        </tr>`;
    }).join('');
}

function renderFG() {
    const inv = (appState.data.inventory || []).filter(i => i.item_class === 'FG');
    const boms = appState.data.boms || [];

    // Count components per FG
    const compCounts = {};
    boms.forEach(b => { compCounts[b.finished_good] = (compCounts[b.finished_good] || 0) + 1; });

    const fgData = inv.map(i => ({ ...i, component_count: compCounts[i.part_number] || 0 }));
    appState._fgData = fgData;
    appState._fgFiltered = fgData;

    document.getElementById('fgCards').innerHTML = `
        <div class="card"><div class="card-label">Finished Goods</div><div class="card-value">${fgData.length}</div></div>
        <div class="card"><div class="card-label">Zero Stock</div><div class="card-value red">${fgData.filter(i => i.on_hand_qty === 0).length}</div></div>
    `;

    renderFGTable(fgData);
}

function filterFG(q) {
    const data = appState._fgData || [];
    const filtered = q ? data.filter(r => r.part_number.toLowerCase().includes(q.toLowerCase())) : data;
    appState._fgFiltered = filtered;
    renderFGTable(filtered);
}

function renderFGTable(data) {
    document.getElementById('fgCount').textContent = `${data.length} items`;
    document.getElementById('fgBody').innerHTML = data.map(r => `<tr>
        <td>${r.part_number}</td>
        <td class="num">${formatNum(r.on_hand_qty)}</td>
        <td class="num">${r.component_count}</td>
    </tr>`).join('');
}

function renderRM() {
    const inv = (appState.data.inventory || []).filter(i => i.item_class === 'RM');
    const boms = appState.data.boms || [];

    // Count how many FGs use each RM
    const usedIn = {};
    boms.forEach(b => {
        if (!usedIn[b.component]) usedIn[b.component] = new Set();
        usedIn[b.component].add(b.finished_good);
    });

    const rmData = inv.map(i => ({ ...i, used_in_count: usedIn[i.part_number] ? usedIn[i.part_number].size : 0 }));
    appState._rmData = rmData;
    appState._rmFiltered = rmData;
    renderRMTable(rmData);
}

function filterRM(q) {
    const data = appState._rmData || [];
    const filtered = q ? data.filter(r => r.part_number.toLowerCase().includes(q.toLowerCase())) : data;
    appState._rmFiltered = filtered;
    renderRMTable(filtered);
}

function renderRMTable(data) {
    document.getElementById('rmCount').textContent = `${data.length} items`;
    document.getElementById('rmBody').innerHTML = data.map(r => `<tr>
        <td>${r.part_number}</td>
        <td class="num">${formatNum(r.on_hand_qty)}</td>
        <td class="num">${r.used_in_count}</td>
    </tr>`).join('');
}

function renderPOs() {
    const pos = appState.data.open_pos || [];
    appState._poData = pos;
    appState._poFiltered = pos;

    // Count vendors
    const vendors = new Set(pos.map(p => p.vendor));
    const totalQty = pos.reduce((s, p) => s + (p.qty_remaining || 0), 0);

    document.getElementById('poCards').innerHTML = `
        <div class="card"><div class="card-label">Open PO Lines</div><div class="card-value">${pos.length}</div></div>
        <div class="card"><div class="card-label">Vendors</div><div class="card-value">${vendors.size}</div></div>
        <div class="card"><div class="card-label">Total Qty Pending</div><div class="card-value">${formatNum(totalQty)}</div></div>
    `;

    renderPOTable(pos);
}

function filterPOs(q) {
    const data = appState._poData || [];
    const ql = q.toLowerCase();
    const filtered = q ? data.filter(r =>
        r.po_num.toLowerCase().includes(ql) ||
        r.vendor.toLowerCase().includes(ql) ||
        r.part.toLowerCase().includes(ql)
    ) : data;
    appState._poFiltered = filtered;
    renderPOTable(filtered);
}

function renderPOTable(data) {
    document.getElementById('poCount').textContent = `${data.length} lines`;
    document.getElementById('poBody').innerHTML = data.map(r => `<tr>
        <td class="num">${r.po_num}</td>
        <td class="po-vendor">${r.vendor}</td>
        <td>${r.part}</td>
        <td class="num">${formatNum(r.qty_remaining)}</td>
        <td>${r.expected_date ? new Date(r.expected_date).toLocaleDateString('en-CA') : '--'}</td>
        <td><span class="badge ${r.status === 'Partial' ? 'badge-atrisk' : 'badge-healthy'}">${r.status}</span></td>
    </tr>`).join('');
}

function renderBOMs() {
    const boms = appState.data.boms || [];
    appState._bomData = boms;
    appState._bomFiltered = boms;
    renderBOMTable(boms);
}

function filterBOMs(q) {
    const data = appState._bomData || [];
    const ql = q.toLowerCase();
    const filtered = q ? data.filter(r =>
        r.finished_good.toLowerCase().includes(ql) ||
        r.component.toLowerCase().includes(ql)
    ) : data;
    appState._bomFiltered = filtered;
    renderBOMTable(filtered);
}

function renderBOMTable(data) {
    document.getElementById('bomCount').textContent = `${data.length} rows`;
    document.getElementById('bomBody').innerHTML = data.map(r => `<tr>
        <td>${r.finished_good}</td>
        <td>${r.component}</td>
        <td class="num">${formatNum(r.qty_per, 2)}</td>
        <td>${r.uom}</td>
    </tr>`).join('');
}

// ============================================================
// FORECAST UPLOAD
// ============================================================
function showForecastUpload() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,.tsv,.txt,.xlsx';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (file.name.endsWith('.xlsx')) {
            // Load SheetJS for XLSX parsing
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.onload = () => {
                const reader = new FileReader();
                reader.onload = (ev) => parseXLSX(ev.target.result);
                reader.readAsArrayBuffer(file);
            };
            document.head.appendChild(script);
        } else {
            const reader = new FileReader();
            reader.onload = (ev) => parseCSVForecast(ev.target.result);
            reader.readAsText(file);
        }
    };
    input.click();
}

function parseXLSX(buffer) {
    const wb = XLSX.read(buffer, { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

    // Detect Kanel forecast format:
    // Row 1: header with month info
    // Row 3: Month labels in cols 7+
    // Row 5: Column headers (Category, Sku, Common Sku, Description, Format, ...)
    // Row 7+: Data rows with monthly forecasts in cols 7-18

    const forecast = {};
    const fbNames = new Set((appState.data?.inventory || []).map(i => i.part_number));
    const fbLower = {};
    fbNames.forEach(n => { fbLower[n.toLowerCase().trim()] = n; });

    // Manual name corrections
    const manualMap = {
        'bonjour, hi.': 'Bonjour, Hi',
        'spice traveler': 'Spice traveler',
        'mineral - pure - salt collection': 'Mineral: Pure - Salt Collection',
    };

    let matched = 0, total = 0;

    // Find the data start (look for row with 'Category' or 'Sku')
    let dataStart = 6; // default for Kanel format
    for (let i = 0; i < Math.min(10, rows.length); i++) {
        const row = rows[i];
        if (row && row[0] && String(row[0]).toLowerCase().includes('category')) {
            dataStart = i + 2; // skip header + blank
            break;
        }
    }

    for (let i = dataStart; i < rows.length; i++) {
        const row = rows[i];
        if (!row || !row[1]) continue; // need SKU code

        const desc = String(row[3] || '').trim();
        if (!desc) continue;
        total++;

        // Sum monthly forecasts (columns 7-18, index 6-17)
        let annual = 0;
        for (let c = 6; c <= 17; c++) {
            const val = parseFloat(row[c]);
            if (!isNaN(val)) annual += val;
        }

        // Smart match to Fishbowl name
        let fbName = matchToFishbowl(desc, fbNames, fbLower, manualMap);
        if (fbName) {
            forecast[fbName] = Math.round(annual * 100) / 100;
            matched++;
        }
    }

    appState.forecast = forecast;
    localStorage.setItem('kanel-hub-forecast', JSON.stringify(forecast));
    alert(`Forecast loaded: ${matched}/${total} SKUs matched to Fishbowl inventory.${
        total - matched > 0 ? ' ' + (total - matched) + ' SKUs could not be matched (likely case packs or collections not in Fishbowl).' : ''
    }`);
    renderAll();
}

function matchToFishbowl(desc, fbNames, fbLower, manualMap) {
    // 1. Manual corrections
    if (manualMap[desc.toLowerCase()]) {
        const mapped = manualMap[desc.toLowerCase()];
        if (fbNames.has(mapped)) return mapped;
    }
    // 2. Exact match
    if (fbNames.has(desc)) return desc;
    // 3. Case insensitive
    const lower = desc.toLowerCase().trim();
    if (fbLower[lower]) return fbLower[lower];
    // 4. Clean whitespace
    const clean = desc.replace(/\s+/g, ' ').trim();
    if (fbNames.has(clean)) return clean;
    if (fbLower[clean.toLowerCase()]) return fbLower[clean.toLowerCase()];
    return null;
}

function parseCSVForecast(text) {
    const lines = text.trim().split('\n');
    const header = lines[0].toLowerCase();
    const isMonthly = header.includes('monthly');
    const forecast = {};

    for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(/[,\t]/);
        if (cols.length >= 2) {
            const sku = cols[0].trim();
            const val = parseFloat(cols[1].trim());
            if (sku && !isNaN(val)) {
                forecast[sku] = isMonthly ? val * 12 : val;
            }
        }
    }

    appState.forecast = forecast;
    localStorage.setItem('kanel-hub-forecast', JSON.stringify(forecast));
    alert(`Loaded forecast for ${Object.keys(forecast).length} SKUs.`);
    renderAll();
}

// ============================================================
// SORTING
// ============================================================
function sortTable(tab, col) {
    if (appState.sortCol[tab] === col) {
        appState.sortDir[tab] = appState.sortDir[tab] === 'asc' ? 'desc' : 'asc';
    } else {
        appState.sortCol[tab] = col;
        appState.sortDir[tab] = 'asc';
    }

    // Update header classes
    document.querySelectorAll(`#tab-${tab} th`).forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.col === col) {
            th.classList.add(appState.sortDir[tab] === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });

    renderAll();
}

// ============================================================
// TAB SWITCHING
// ============================================================
function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
}

function setWohFilter(f) {
    appState.wohFilter = f;
    renderWOH();
}

// ============================================================
// EXPORT
// ============================================================
function exportCSV(tab) {
    let rows = [];
    let filename = 'export.csv';

    if (tab === 'woh') {
        const data = calculateWOH(appState.data.inventory || []);
        rows = [['SKU','Type','On Hand','Committed','Available','Weekly Forecast','WOH','Status']];
        data.forEach(r => rows.push([r.part_number, r.item_class, r.on_hand_qty, r.committed_qty || 0, r.available_qty, r.weekly_forecast || '', r.woh || '', getStatusLabel(r.status)]));
        filename = `Kanel_WOH_${new Date().toISOString().slice(0,10)}.csv`;
    } else if (tab === 'fg') {
        const data = appState._fgFiltered || [];
        rows = [['SKU','On Hand','Components']];
        data.forEach(r => rows.push([r.part_number, r.on_hand_qty, r.component_count]));
        filename = `Kanel_FG_${new Date().toISOString().slice(0,10)}.csv`;
    } else if (tab === 'rm') {
        const data = appState._rmFiltered || [];
        rows = [['Material','On Hand','Used In']];
        data.forEach(r => rows.push([r.part_number, r.on_hand_qty, r.used_in_count]));
        filename = `Kanel_RM_${new Date().toISOString().slice(0,10)}.csv`;
    } else if (tab === 'pos') {
        const data = appState._poFiltered || [];
        rows = [['PO','Vendor','Part','Qty Remaining','Expected','Status']];
        data.forEach(r => rows.push([r.po_num, r.vendor, r.part, r.qty_remaining, r.expected_date, r.status]));
        filename = `Kanel_OpenPOs_${new Date().toISOString().slice(0,10)}.csv`;
    } else if (tab === 'boms') {
        const data = appState._bomFiltered || [];
        rows = [['Finished Good','Component','Qty Per','UOM']];
        data.forEach(r => rows.push([r.finished_good, r.component, r.qty_per, r.uom]));
        filename = `Kanel_BOMs_${new Date().toISOString().slice(0,10)}.csv`;
    }

    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}

// ============================================================
// UTILITIES
// ============================================================
function formatNum(n, decimals = 0) {
    if (n === null || n === undefined || isNaN(n)) return '--';
    return Number(n).toLocaleString('en-CA', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
    });
}

// ============================================================
// INIT
// ============================================================
loadConfig();
</script>
</body>
</html>
