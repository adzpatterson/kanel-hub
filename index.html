<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kanel Supply Chain Hub</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0c;--surface:#141418;--surface-2:#1c1c22;--border:#2a2a32;--text:#e8e8ec;--text-muted:#8b8b96;--accent:#d4a853;--accent-dim:#d4a85320;--red:#e54d4d;--red-bg:#e54d4d15;--orange:#e8923a;--orange-bg:#e8923a15;--blue:#4d9ee5;--blue-bg:#4d9ee515;--green:#4dc77a;--green-bg:#4dc77a15;--gray:#555;--gray-bg:#55555515;--radius:10px;--font:'DM Sans',-apple-system,sans-serif;--mono:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
.header{display:flex;align-items:center;justify-content:space-between;padding:20px 32px;border-bottom:1px solid var(--border);background:var(--surface)}
.header-left{display:flex;align-items:center;gap:16px}
.header-right{display:flex;align-items:center;gap:12px}
.logo{font-size:24px;font-weight:700;color:var(--accent);letter-spacing:-0.5px}
.logo-sub{font-size:12px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
.last-updated{font-size:12px;color:var(--text-muted);font-family:var(--mono)}
.refresh-btn{display:flex;align-items:center;gap:6px;padding:8px 16px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);cursor:pointer;font-family:var(--font);font-size:13px;transition:all .15s}
.refresh-btn:hover{border-color:var(--accent);color:var(--accent)}
.refresh-btn svg{width:16px;height:16px}
.nav{display:flex;gap:2px;padding:0 32px;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto}
.nav-tab{padding:12px 20px;font-size:13px;font-weight:500;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.main{padding:24px 32px}
.hidden{display:none!important}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.card-label{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:4px}
.card-value{font-size:22px;font-weight:700;font-family:var(--mono)}
.card-value.red{color:var(--red)}.card-value.orange{color:var(--orange)}.card-value.blue{color:var(--blue)}.card-value.green{color:var(--green)}.card-value.gray{color:var(--gray)}
.filters{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;align-items:center}
.filter-btn{padding:6px 14px;background:transparent;border:1px solid var(--border);border-radius:20px;color:var(--text-muted);cursor:pointer;font-family:var(--font);font-size:12px;transition:all .15s}
.filter-btn:hover{border-color:var(--text);color:var(--text)}
.filter-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.filter-btn .count{margin-left:6px;font-family:var(--mono);font-size:11px;opacity:.7}
.search-input{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 14px;color:var(--text);font-family:var(--font);font-size:13px;width:220px;outline:none}
.search-input:focus{border-color:var(--accent)}
.export-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.export-btn{padding:6px 14px;background:var(--surface-2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-muted);cursor:pointer;font-family:var(--font);font-size:12px}
.export-btn:hover{border-color:var(--accent);color:var(--accent)}
.result-count{font-size:12px;color:var(--text-muted);font-family:var(--mono)}
.table-wrap{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.table-scroll{overflow-x:auto;max-height:70vh;overflow-y:auto}
table{width:100%;border-collapse:collapse}
thead{position:sticky;top:0;z-index:2}
thead th{padding:10px 14px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);background:var(--surface-2);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
thead th:hover{color:var(--text)}
tbody td{padding:10px 14px;border-bottom:1px solid var(--border);white-space:nowrap}
tbody tr:hover{background:var(--surface-2)}
.num{font-family:var(--mono);text-align:right}
.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:600;letter-spacing:.3px}
.badge-oos{background:var(--gray-bg);color:#999;border:1px solid #44444480}
.badge-critical{background:var(--red-bg);color:var(--red);border:1px solid #e54d4d40}
.badge-atrisk{background:var(--orange-bg);color:var(--orange);border:1px solid #e8923a40}
.badge-healthy{background:var(--blue-bg);color:var(--blue);border:1px solid #4d9ee540}
.badge-excess{background:var(--green-bg);color:var(--green);border:1px solid #4dc77a40}
.woh-bar{width:100px;height:8px;background:var(--surface);border-radius:4px;overflow:hidden}
.woh-bar-fill{height:100%;border-radius:4px;transition:width .3s}
.bar-cell{padding:10px 14px}
.setup-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:16px;padding:32px}
.setup-screen h2{font-size:28px;color:var(--accent)}
.setup-screen p{color:var(--text-muted);text-align:center;max-width:400px}
.setup-screen label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;align-self:center}
.setup-screen input{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px;color:var(--text);font-family:var(--mono);font-size:14px;width:320px;text-align:center}
.setup-btn{padding:10px 32px;background:var(--accent);border:none;border-radius:var(--radius);color:#000;font-weight:600;cursor:pointer;font-family:var(--font);font-size:14px}
.setup-error{color:var(--red);font-size:13px;display:none;text-align:center}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.po-group{cursor:pointer;background:var(--surface-2)}
.po-group:hover{background:#1f1f28}
.po-group td{font-weight:600;padding:12px 14px}
.po-detail{display:none}
.po-detail.open{display:table-row}
.po-detail td{padding-left:40px;font-size:13px;color:var(--text-muted)}
select.hs{background:var(--surface-2);color:var(--text);border:1px solid var(--border);padding:4px 8px;border-radius:6px;font-family:var(--font);font-size:13px}
@media(max-width:768px){.header{padding:16px}.nav{padding:0 16px}.main{padding:16px}.cards{grid-template-columns:repeat(2,1fr)}.search-input{width:100%}}
</style>
</head>
<body>
<div id="setupScreen" class="setup-screen">
<h2>Kanel Supply Chain Hub</h2>
<p>Make sure the proxy is running.<br><code style="background:var(--bg);padding:2px 6px;border-radius:4px;font-family:var(--mono)">node proxy.js</code></p>
<label>Proxy URL</label>
<input type="text" id="setupUrl" value="http://localhost:3847" placeholder="http://localhost:3847">
<button class="setup-btn" onclick="saveConfig()">Connect</button>
<div id="setupError" class="setup-error"></div>
</div>

<div id="app" class="hidden">
<div class="header">
<div class="header-left"><div><div class="logo">Kanel</div><div class="logo-sub">Supply Chain Hub</div></div></div>
<div class="header-right">
<span class="last-updated" id="lastUpdated"></span>
<button class="refresh-btn" onclick="exportAllXLSX()" style="background:transparent;border:1px solid var(--border);margin-right:8px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" style="width:16px;height:16px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export All</button>
<button class="refresh-btn" id="refreshBtn" onclick="refreshData()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>Refresh</button>
</div></div>

<div class="nav">
<div class="nav-tab active" data-tab="woh" onclick="switchTab('woh')">Weeks on Hand</div>
<div class="nav-tab" data-tab="rmdemand" onclick="switchTab('rmdemand')">RM Demand</div>
<div class="nav-tab" data-tab="casepack" onclick="switchTab('casepack')">Case Pack Builder</div>
<div class="nav-tab" data-tab="axia" onclick="switchTab('axia')">Axia Production</div>
<div class="nav-tab" data-tab="pos" onclick="switchTab('pos')">Open POs</div>
<div class="nav-tab" data-tab="boms" onclick="switchTab('boms')">BOMs</div>
<div class="nav-tab" data-tab="manage" onclick="switchTab('manage')">Manage Items</div>
</div>

<div class="main">
<!-- WOH -->
<div id="tab-woh" class="tab-content"><div class="cards" id="wohCards"></div><div class="filters" id="wohFilters"></div>
<div class="export-bar"><span class="result-count" id="wohCount"></span><button class="export-btn" onclick="xcsv('woh')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead><tr>
<th onclick="srt('woh','pn')">Product</th><th onclick="srt('woh','cat')">Category</th><th onclick="srt('woh','oh')">On Hand</th><th onclick="srt('woh','cm')">Committed</th><th onclick="srt('woh','av')">Available</th><th onclick="srt('woh','wf')">Wkly Fcst</th><th onclick="srt('woh','doh')">DOH</th><th onclick="srt('woh','woh')">WOH</th><th onclick="srt('woh','moh')">MOH</th><th>Bar</th><th onclick="srt('woh','st')">Status</th>
</tr></thead><tbody id="wohBody"></tbody></table></div></div></div>

<!-- RM DEMAND -->
<div id="tab-rmdemand" class="tab-content hidden"><div class="cards" id="rmdemandCards"></div>
<div class="filters"><input type="text" class="search-input" placeholder="Search materials..." oninput="S.rmQ=this.value;rRMD()">
<select class="hs" id="rmCatF" onchange="S.rmCat=this.value;rRMD()"><option value="all">All Categories</option></select></div>
<div class="export-bar"><span class="result-count" id="rmdemandCount"></span><button class="export-btn" onclick="xcsv('rmdemand')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="rmdemandHead"></thead><tbody id="rmdemandBody"></tbody></table></div></div></div>

<!-- CASE PACK BUILDER -->
<div id="tab-casepack" class="tab-content hidden"><div class="cards" id="casepackCards"></div>
<div class="filters" id="cpFilters"></div>
<div class="export-bar"><span class="result-count" id="casepackCount"></span>
<button class="export-btn" onclick="printWO()" style="margin-right:8px">Print Work Order</button>
<button class="export-btn" onclick="xcsv('casepack')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="cpHead"></thead><tbody id="cpBody"></tbody></table></div></div></div>

<!-- AXIA -->
<div id="tab-axia" class="tab-content hidden"><div class="cards" id="axiaCards"></div><div class="filters" id="axiaFilters"></div>
<div class="export-bar"><span class="result-count" id="axiaCount"></span><button class="export-btn" onclick="xcsv('axia')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead id="axiaHead"></thead><tbody id="axiaBody"></tbody></table></div></div></div>

<!-- OPEN POs -->
<div id="tab-pos" class="tab-content hidden"><div class="cards" id="poCards"></div>
<div class="filters"><input type="text" class="search-input" placeholder="Search POs..." oninput="S.poQ=this.value;rPO()"></div>
<div class="export-bar"><span class="result-count" id="poCount"></span><button class="export-btn" onclick="xcsv('pos')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead><tr>
<th>PO # / Vendor</th><th>Part</th><th>Qty Remaining</th><th>Expected</th><th>Status</th>
</tr></thead><tbody id="poBody"></tbody></table></div></div></div>

<!-- BOMs -->
<div id="tab-boms" class="tab-content hidden">
<div class="filters"><input type="text" class="search-input" placeholder="Search BOMs..." oninput="S.bomQ=this.value;rBOM()"></div>
<div class="export-bar"><span class="result-count" id="bomCount"></span><button class="export-btn" onclick="xcsv('boms')">Export CSV</button></div>
<div class="table-wrap"><div class="table-scroll"><table><thead><tr>
<th onclick="srt('boms','fg')">Finished Good</th><th onclick="srt('boms','cp')">Component</th><th>Qty Per</th><th>UOM</th>
</tr></thead><tbody id="bomBody"></tbody></table></div></div></div>

<!-- MANAGE ITEMS -->
<div id="tab-manage" class="tab-content hidden">
<div style="padding:0 0 16px">
<p style="color:var(--text-muted);margin-bottom:12px">Control which items appear in reports. Excluded items are hidden from all tabs.</p>
<div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap">
<input type="text" class="search-input" id="manageSearch" placeholder="Search items..." oninput="rManage()" style="flex:1;min-width:200px">
<select class="hs" id="manageFilter" onchange="rManage()"><option value="all">All</option><option value="included">Included</option><option value="excluded">Excluded</option><option value="fg">Finished Goods</option><option value="rm">Raw Materials</option></select>
<button class="filter-btn" onclick="autoExclude()" style="border-color:var(--orange);color:var(--orange)">Auto-Exclude Junk</button>
</div>
<div class="export-bar"><span class="result-count" id="manageCount"></span></div>
</div>
<div class="table-wrap"><div class="table-scroll"><table><thead><tr><th style="width:60px">Include</th><th>Part Number</th><th>Type</th><th>On Hand</th></tr></thead>
<tbody id="manageBody"></tbody></table></div></div></div>

</div></div>

<script>
// ======== REFERENCE DATA ========
const AUTO_EXCL = ["Demo Jar","Shelf Talker","Signage","Personalized Gift Box Bundle","POP -","Shelf Display","Floor Stand","Easel","Stacker -","Build a Box Test","Build your own","Choose your own","Kanel Cards","Kanel Gift Cards","Kanel holiday sign","Custom Sleeve","DIY Sleeves","Hang Tag","Personalized card","Perfectly Imperfect","NLVA Copacking","Replacement part","Sobeys Stand Up","25.00 CA$","GIF-0008-C","GIF-0028-","Labour -","Sapio_Glass Seal","Stacker Seal"];
const MOQ = {"Holiday Cocktail Trio":1000,"The Ultimate Caesar":1000,"Spicy Jalapeno & Lime":1000,"Lemon Blueberry Bombshell":1000,"Salt + chili Margarita":1000,"Gingerbread":1000,"Cranberry Spruce Spritz":1000,"White Chocolate Peppermint":1000,"Sour Cherry":1000,"All the Salts":1000,"Summer Black Truffle Salt":1000,"Holy Grail Garlic Salt":1000,"Quebec Maple Smoked Salt":1000,"Organic Fleur de Sel Rouge":1000,"Charred Lemon Sea Salt":1000,"Cold Smoked Sea Salt":1000,"Summer Sea Salt":1000,"Fiery Sea Salt":1000,"A Sprinkle of Sunshine":1000,"Organic La Vita e Bella":1000,"Organic Cinnamon Toast":1000,"Butcher's Block":1000,"Montreal Bagel Spice":1000,"Organic Green Goddess":1000,"Fresh Salted Peppercorns":1000,"Stockholm Lemon & Dill":1000,"Organic Taco Night":1000,"Hawaiian 'Ono Poke":1000,"Ole Smoky Rub":1000,"Santa Fe Chipotle Honey":1000,"Sweet & Smoky Rub":1000,"For The Love of BBQ":1000,"Bangkok Night Market":1000,"Organic Louisiana Fried Chicken":1000,"Aglio Napoletano":1000,"Organic Spicy Chili Crunch":1000,"Tuscan Affair":1000,"Organic Sunday Roast":1000,"Sweet Korean Heat":1000,"Vadouvan Curry":1000,"Porcini Umami Rub":1000,"Organic Cacao Apple Crisp":1000,"Golden Lemon Turmeric":1000,"Organic Forbidden Tonka Sugar":1000,"Organic Smoked Peppercorns":1000};

// ======== STATE ========
let S = {config:null,data:null,forecast:{},fm:{},mL:[],excluded:{},wohFilter:'all',wohSearch:'',rmQ:'',rmCat:'all',poQ:'',bomQ:'',cpQ:'',axQ:'',
  sortC:{},sortD:{},axiaBM:3,cpBM:1,cpSel:null,_c:{}};

// ======== UTILS ========
function fmt(n,d=0){if(n===null||n===undefined||isNaN(n))return'--';return Number(n).toLocaleString('en-CA',{minimumFractionDigits:d,maximumFractionDigits:d});}
function bdg(s){const m={oos:'badge-oos">OOS',critical:'badge-critical">CRITICAL',atrisk:'badge-atrisk">AT RISK',healthy:'badge-healthy">HEALTHY',excess:'badge-excess">EXCESS'};return m[s]?`<span class="badge ${m[s]}</span>`:'<span class="badge" style="opacity:.4">--</span>';}
function sLbl(s){return{oos:'OOS',critical:'CRITICAL',atrisk:'AT RISK',healthy:'HEALTHY',excess:'EXCESS'}[s]||'';}
function bClr(s){return{oos:'var(--gray)',critical:'var(--red)',atrisk:'var(--orange)',healthy:'var(--blue)',excess:'var(--green)'}[s]||'var(--gray)';}
function toKg(q,u){const l=(u||'').toLowerCase();if(l==='gram'||l==='g')return q/1000;if(l==='kilogram'||l==='kg')return q;if(l==='454g bag')return q*0.454;if(l==='5kg bag')return q*5;return q;}
function isWt(u){return['gram','g','kilogram','kg','454g bag','5kg bag'].includes((u||'').toLowerCase());}
function dU(u){return isWt(u)?'kg':u;}
function inc(n){return!S.excluded[n];}

function getCat(n){
  const l=n.toLowerCase();
  if(l.includes('rimmer')||l.includes('caesar')||l.includes('margarita')&&!l.includes('bulk')&&!l.includes('label')&&!l.includes('tin')||l.includes('bombshell')&&!l.includes('bulk')||l.includes('spritz')&&!l.includes('bulk')||l.includes('gingerbread')&&!l.includes('bulk')||l.includes('peppermint')&&!l.includes('bulk')||l.includes('sour cherry')&&!l.includes('bulk')||l.includes('holiday cocktail'))return'Cocktail Rimmer';
  if(l.includes('refill bag'))return'Refill';
  if(l.includes('case pack'))return'Case Pack';
  if(l.includes('collection')||l.includes('duo')&&!l.includes('sleeve')||l.includes('trio')||l.includes('gift')||l.includes('bonjour')||l.includes('traveler')||l.includes('edit ')&&!l.includes('salt')||l.includes('bright &')||l.includes('bring the'))return'Gift';
  if(l.includes(' salt')||l.includes('fleur de sel')||l.includes('pearl')||l.includes('flake salt')||l.includes('peppercorn')&&!l.includes('bulk'))return'Sea Salt';
  return'Spice Blend';
}

function catRM(n){
  const l=n.toLowerCase();
  if(l.startsWith('bulk'))return'Bulk Ingredients';
  if(l.startsWith('label')||l.includes('round label'))return'Labels';
  if(l.includes('tube'))return'Tubes';
  if(l.includes('bag')||l.includes('pouch')||l.includes('compostable'))return'Bags & Pouches';
  if(l.startsWith('box')||l.includes('insert')||l.includes('sleeve'))return'Boxes & Inserts';
  if(l.includes('jar')||l.includes('lid')||l.includes('glass'))return'Jars & Lids';
  if(l.includes('tin')||l.startsWith('rm-rimmer'))return'Tins';
  if(l.includes('case pack'))return'Case Pack Boxes';
  return'Other Components';
}

// ======== NAV & SORT ========
function switchTab(t){document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden'));document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));document.getElementById('tab-'+t).classList.remove('hidden');document.querySelector(`.nav-tab[data-tab="${t}"]`).classList.add('active');if(t==='manage')rManage();}
function srt(tab,col){if(S.sortC[tab]===col)S.sortD[tab]=S.sortD[tab]==='a'?'d':'a';else{S.sortC[tab]=col;S.sortD[tab]='a';}const dir=S.sortD[tab]==='a'?1:-1;const d=S._c[tab+'F']||[];d.sort((a,b)=>{let va=a[col],vb=b[col];if(va==null)return 1;if(vb==null)return-1;if(typeof va==='string')return va.localeCompare(vb)*dir;return(va-vb)*dir;});const rn={woh:rWOHT,rmdemand:rRMDT,casepack:rCPT,axia:rAXT,boms:rBOMT,pos:rPOT};if(rn[tab])rn[tab](d);}

// ======== FORECAST ========
function showFU(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.xlsx,.xls,.csv';
  inp.onchange=async(e)=>{
    const file=e.target.files[0];if(!file)return;
    if(!window.XLSX){const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';document.head.appendChild(s);await new Promise(r=>s.onload=r);}
    const data=await file.arrayBuffer();const wb=XLSX.read(data);const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
    const annual={},monthly={},ml=[];let hdr=-1;
    for(let i=0;i<Math.min(10,rows.length);i++){if(rows[i]&&rows[i].length>8){let mc=0;for(let c=5;c<rows[i].length;c++){if(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i.test(String(rows[i][c]||'')))mc++;}if(mc>=2){hdr=i;break;}}}
    if(hdr>=0){
      for(let c=6;c<=18&&c<rows[hdr].length;c++){const l=String(rows[hdr][c]).trim();if(l&&/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i.test(l))ml.push(l);}
      const inv=(S.data&&S.data.inventory)||[];const pn=inv.map(i=>i.part_number);
      let matched=0,total=0;
      const corr={"Bonjour, Hi.":"Bonjour, Hi","Spice Traveler":"Spice traveler","epices a Rosbif":"epices a rosbif"};
      // Detect name column: scan ahead to find first row with actual product data
      let nameCol=0,dataStart=hdr+1;
      for(let i=hdr+1;i<Math.min(hdr+8,rows.length);i++){
        const r=rows[i];if(!r)continue;
        // Skip header-like rows (Fct, Category, blank)
        const c0=String(r[0]||'').trim().toLowerCase();
        if(!c0||c0==='fct'||c0==='category'||c0==='month')continue;
        // Found a data row - check if col 3 has a description
        if(r[3]&&String(r[3]).trim().length>2){nameCol=3;}
        dataStart=i;break;
      }
      for(let i=dataStart;i<rows.length;i++){
        const r=rows[i];if(!r)continue;let name=String(r[nameCol]||'').trim();if(!name||name==='None'||name.toLowerCase()==='category')continue;total++;
        let mn=pn.find(p=>p===name)||pn.find(p=>p.toLowerCase()===name.toLowerCase())||pn.find(p=>p.replace(/\s+/g,' ').toLowerCase()===name.replace(/\s+/g,' ').toLowerCase());
        if(!mn&&corr[name])mn=pn.find(p=>p===corr[name]);
        const key=mn||name;let yr=0;const mo=[];
        for(let c=6;c<=18&&c<r.length;c++){const v=parseFloat(r[c])||0;yr+=v;mo.push(v);}
        if(yr>0){annual[key]=yr;monthly[key]=mo;if(mn)matched++;}
      }
      S.mL=ml;alert(`Forecast loaded: ${matched}/${total} SKUs matched`);
    }
    S.forecast=annual;S.fm=monthly;
    localStorage.setItem('kh-fc',JSON.stringify(annual));localStorage.setItem('kh-fm',JSON.stringify(monthly));localStorage.setItem('kh-ml',JSON.stringify(ml));
    renderAll();
  };inp.click();
}

// ======== WOH (FG only, uses Available) ========
function calcWOH(){
  const inv=(S.data.inventory||[]).filter(i=>i.item_class==='FG'&&inc(i.part_number));
  return inv.map(item=>{
    const fc=S.forecast[item.part_number];const wf=fc?fc/52:null;
    const av=item.available_qty!==undefined?item.available_qty:item.on_hand_qty;
    let woh=null,doh=null,moh=null,st='nf';
    if(wf&&wf>0){woh=av/wf;doh=Math.round(woh*7);moh=Math.round(woh/4.33*10)/10;
      if(av===0)st='oos';else if(woh<4)st='critical';else if(woh<8)st='atrisk';else if(woh<=20)st='healthy';else st='excess';
    }else if(av===0){st='oos';woh=0;doh=0;moh=0;}
    return{pn:item.part_number,cat:getCat(item.part_number),oh:item.on_hand_qty,cm:item.committed_qty||0,av,wf,doh,woh,moh,st};
  });
}
function rWOH(){
  const d=calcWOH();S._c.woh=d;S._c.wohF=d;
  const c={oos:0,critical:0,atrisk:0,healthy:0,excess:0};d.forEach(r=>{if(c[r.st]!==undefined)c[r.st]++;});
  const hf=Object.keys(S.forecast).length>0;
  document.getElementById('wohCards').innerHTML=`
    <div class="card"><div class="card-label">FG SKUs</div><div class="card-value">${d.length}</div></div>
    <div class="card"><div class="card-label">Out of Stock</div><div class="card-value gray">${c.oos}</div></div>
    <div class="card"><div class="card-label">Critical</div><div class="card-value red">${c.critical}</div></div>
    <div class="card"><div class="card-label">At Risk</div><div class="card-value orange">${c.atrisk}</div></div>
    <div class="card"><div class="card-label">Healthy</div><div class="card-value blue">${c.healthy}</div></div>
    <div class="card"><div class="card-label">Excess</div><div class="card-value green">${c.excess}</div></div>`;
  document.getElementById('wohFilters').innerHTML=`
    <button class="filter-btn ${S.wohFilter==='all'?'active':''}" onclick="S.wohFilter='all';rWOHT()">All<span class="count">${d.length}</span></button>
    <button class="filter-btn ${S.wohFilter==='oos'?'active':''}" onclick="S.wohFilter='oos';rWOHT()">OOS<span class="count">${c.oos}</span></button>
    <button class="filter-btn ${S.wohFilter==='critical'?'active':''}" onclick="S.wohFilter='critical';rWOHT()">Critical<span class="count">${c.critical}</span></button>
    <button class="filter-btn ${S.wohFilter==='atrisk'?'active':''}" onclick="S.wohFilter='atrisk';rWOHT()">At Risk<span class="count">${c.atrisk}</span></button>
    <button class="filter-btn ${S.wohFilter==='healthy'?'active':''}" onclick="S.wohFilter='healthy';rWOHT()">Healthy<span class="count">${c.healthy}</span></button>
    <button class="filter-btn ${S.wohFilter==='excess'?'active':''}" onclick="S.wohFilter='excess';rWOHT()">Excess<span class="count">${c.excess}</span></button>
    <input type="text" class="search-input" placeholder="Search..." oninput="S.wohSearch=this.value;rWOHT()" value="${S.wohSearch}">
    ${!hf?'<button class="filter-btn" style="border-color:var(--accent);color:var(--accent)" onclick="showFU()">+ Upload Forecast</button>':'<button class="filter-btn" onclick="showFU()">Update Forecast</button>'}`;
  rWOHT();
}
function rWOHT(d){
  if(!d){d=S._c.woh||[];if(S.wohFilter!=='all')d=d.filter(r=>r.st===S.wohFilter);if(S.wohSearch){const q=S.wohSearch.toLowerCase();d=d.filter(r=>r.pn.toLowerCase().includes(q));}}
  S._c.wohF=d;document.getElementById('wohCount').textContent=`${d.length} items`;
  document.getElementById('wohBody').innerHTML=d.map(r=>{const bw=r.woh!==null?Math.min(100,r.woh/30*100):0;
    return`<tr><td>${r.pn}</td><td style="font-size:12px;color:var(--text-muted)">${r.cat}</td>
    <td class="num">${fmt(r.oh)}</td><td class="num" style="color:${r.cm>0?'var(--orange)':'var(--text-muted)'}">${fmt(r.cm)}</td>
    <td class="num" style="font-weight:600">${fmt(r.av)}</td><td class="num">${r.wf!==null?fmt(r.wf,1):'--'}</td>
    <td class="num" style="color:var(--text-muted)">${r.doh!==null?fmt(r.doh):'--'}</td>
    <td class="num" style="font-weight:600">${r.woh!==null?fmt(r.woh,1):'--'}</td>
    <td class="num" style="color:var(--text-muted)">${r.moh!==null?fmt(r.moh,1):'--'}</td>
    <td class="bar-cell"><div class="woh-bar"><div class="woh-bar-fill" style="width:${bw}%;background:${bClr(r.st)}"></div></div></td>
    <td>${bdg(r.st)}</td></tr>`;}).join('');
}

// ======== RM DEMAND (UOM converted, monthly, categorized like Excel) ========
function calcRMD(){
  const boms=S.data.boms||[],inv=S.data.inventory||[],fc=S.forecast||{},fm=S.fm||{},pos=S.data.open_pos||[],ml=S.mL||[];
  const iL={};inv.forEach(i=>{iL[i.part_number]={oh:i.on_hand_qty||0,av:i.available_qty!==undefined?i.available_qty:i.on_hand_qty||0};});
  const pL={};pos.forEach(p=>{pL[p.part]=(pL[p.part]||0)+(p.qty_remaining||0);});
  const rm={};
  boms.forEach(b=>{
    const ff=fc[b.finished_good];if(!ff||ff<=0)return;if(!inc(b.component))return;
    const k=b.component,w=isWt(b.uom),qn=w?toKg(b.qty_per,b.uom):b.qty_per,u=dU(b.uom);
    if(!rm[k])rm[k]={cp:k,uom:u,annual:0,ui:new Set(),mo:ml.map(()=>0),rmCat:catRM(k)};
    rm[k].annual+=qn*ff;rm[k].ui.add(b.finished_good);
    const fgm=fm[b.finished_good];if(fgm)for(let i=0;i<fgm.length&&i<rm[k].mo.length;i++)rm[k].mo[i]+=qn*fgm[i];
  });
  return Object.values(rm).map(r=>{
    const i=iL[r.cp]||{oh:0,av:0};const po=pL[r.cp]||0;const md=r.annual/12;
    const mos=md>0?i.av/md:999;const net=Math.max(0,r.annual-i.av-po);
    let st;if(i.av===0&&r.annual>0)st='oos';else if(mos<1)st='critical';else if(mos<3)st='atrisk';else if(mos<=6)st='healthy';else st='excess';
    return{...r,uic:r.ui.size,oh:i.oh,av:i.av,po,md:Math.round(md*10)/10,mos:Math.round(mos*10)/10,net:Math.round(net),st};
  }).filter(r=>r.annual>0).sort((a,b)=>a.mos-b.mos);
}
function rRMD(){
  const all=calcRMD();S._c.rmdemand=all;
  const cats=new Set(all.map(r=>r.rmCat));
  const sel=document.getElementById('rmCatF');const cur=S.rmCat||'all';
  sel.innerHTML='<option value="all">All Categories</option>'+[...cats].sort().map(c=>`<option value="${c}" ${c===cur?'selected':''}>${c}</option>`).join('');
  let d=all;if(S.rmCat&&S.rmCat!=='all')d=d.filter(r=>r.rmCat===S.rmCat);
  if(S.rmQ)d=d.filter(r=>r.cp.toLowerCase().includes(S.rmQ.toLowerCase()));
  S._c.rmdemandF=d;
  const c={oos:0,critical:0,atrisk:0,healthy:0,excess:0};all.forEach(r=>{if(c[r.st]!==undefined)c[r.st]++;});
  const ml=S.mL||[];
  document.getElementById('rmdemandCards').innerHTML=`
    <div class="card"><div class="card-label">Materials</div><div class="card-value">${all.length}</div></div>
    <div class="card"><div class="card-label">Out of Stock</div><div class="card-value gray">${c.oos}</div></div>
    <div class="card"><div class="card-label">Critical (&lt;1mo)</div><div class="card-value red">${c.critical}</div></div>
    <div class="card"><div class="card-label">At Risk (1-3mo)</div><div class="card-value orange">${c.atrisk}</div></div>`;
  document.getElementById('rmdemandHead').innerHTML=`<tr>
    <th onclick="srt('rmdemand','cp')">Material</th><th>Category</th><th>UOM</th>
    ${ml.map(m=>`<th style="font-size:10px">${m.substring(0,3)}</th>`).join('')}
    <th onclick="srt('rmdemand','annual')">TOTAL</th><th onclick="srt('rmdemand','oh')">OH</th><th onclick="srt('rmdemand','po')">Open PO</th><th onclick="srt('rmdemand','net')">Net Need</th><th onclick="srt('rmdemand','mos')">MOS</th><th>Status</th></tr>`;
  rRMDT(d);
}
function rRMDT(d){
  if(!d)d=S._c.rmdemandF||[];
  const ml=S.mL||[];
  document.getElementById('rmdemandCount').textContent=`${d.length} materials`;
  document.getElementById('rmdemandBody').innerHTML=d.map(r=>`<tr>
    <td>${r.cp}</td><td style="font-size:11px;color:var(--text-muted)">${r.rmCat}</td><td>${r.uom}</td>
    ${(r.mo||[]).map(v=>`<td class="num" style="font-size:11px">${fmt(Math.round(v))}</td>`).join('')}
    <td class="num" style="font-weight:600">${fmt(Math.round(r.annual))}</td>
    <td class="num">${fmt(r.oh,1)}</td><td class="num" style="color:var(--blue)">${fmt(r.po)}</td>
    <td class="num" style="font-weight:600;color:${r.net>0?'var(--red)':'var(--green)'}">${fmt(r.net)}</td>
    <td class="num">${r.mos>=999?'N/A':fmt(r.mos,1)}</td><td>${bdg(r.st)}</td></tr>`).join('');
}

// ======== CASE PACK BUILDER ========
function calcCP(){
  const boms=S.data.boms||[],inv=S.data.inventory||[],fc=S.forecast||{},fm=S.fm||{},ml=S.mL||[];
  const iL={};inv.forEach(i=>{iL[i.part_number]=i.available_qty!==undefined?i.available_qty:i.on_hand_qty||0;});
  const ohL={};inv.forEach(i=>{ohL[i.part_number]=i.on_hand_qty||0;});
  const bomByFG={};boms.forEach(b=>{if(!bomByFG[b.finished_good])bomByFG[b.finished_good]=[];bomByFG[b.finished_good].push(b);});
  const kit=/case pack|collection|duo|kit|trio|gift box|edit |shaken|holiday spirit|bright|bring|bonjour|bbq duo|smoke & fire|roasted & raw|top 5|sapio|voyager|mineral|spice lover|family fave|best seller|full spice|traveler/i;
  const results=[];
  Object.entries(bomByFG).forEach(([fg,comps])=>{
    if(!kit.test(fg)||!inc(fg))return;
    const ffc=fc[fg]||0;const fgm=fm[fg]||ml.map(()=>0);
    const bm=S.cpBM||1;
    const demand=fgm.slice(0,bm).reduce((s,v)=>s+v,0)||ffc/12*bm;
    const onHand=ohL[fg]||0;const need=Math.max(0,Math.ceil(demand-onHand));
    let canBuild=Infinity,limComp='';
    const compList=[];
    comps.forEach(c=>{
      if(c.qty_per<=0)return;const cl=c.component.toLowerCase();if(cl.includes('labour'))return;
      const av=iL[c.component]||0;const poss=Math.floor(av/c.qty_per);
      compList.push({name:c.component,qtyPer:c.qty_per,available:av,canMake:poss});
      if(poss<canBuild){canBuild=poss;limComp=c.component;}
    });
    if(canBuild===Infinity)canBuild=0;
    let st;if(need<=0)st='excess';else if(canBuild===0)st='critical';else if(canBuild<need)st='atrisk';else st='healthy';
    results.push({pn:fg,oh:onHand,demand:Math.round(demand),need,canBuild,limComp,comps:compList,ffc:Math.round(ffc),st,
      moArr:fgm.map(v=>Math.round(v))});
  });
  return results.sort((a,b)=>{const so={critical:0,atrisk:1,healthy:2,excess:3};return(so[a.st]||9)-(so[b.st]||9);});
}
function rCP(){
  const d=calcCP();S._c.casepack=d;S._c.casepackF=d;
  const ml=S.mL||[];
  const nb=d.filter(r=>r.need>0).length;const cb0=d.filter(r=>r.canBuild===0&&r.need>0).length;
  document.getElementById('casepackCards').innerHTML=`
    <div class="card"><div class="card-label">Kits / Packs</div><div class="card-value">${d.length}</div></div>
    <div class="card"><div class="card-label">Need to Build</div><div class="card-value orange">${nb}</div></div>
    <div class="card"><div class="card-label">Cannot Build</div><div class="card-value red">${cb0}</div></div>
    <div class="card"><div class="card-label">Covered</div><div class="card-value green">${d.length-nb}</div></div>`;
  document.getElementById('cpFilters').innerHTML=`
    <input type="text" class="search-input" placeholder="Search kits..." oninput="S.cpQ=this.value;rCPT()">
    <label style="color:var(--text-muted);font-size:13px;margin-left:12px">Build for
    <select class="hs" onchange="S.cpBM=parseInt(this.value);rCP()">${[1,2,3,4,5,6].map(n=>`<option value="${n}" ${n===S.cpBM?'selected':''}>${n} mo</option>`).join('')}</select></label>`;
  document.getElementById('cpHead').innerHTML=`<tr>
    <th onclick="srt('casepack','pn')">Product</th><th onclick="srt('casepack','oh')">On Hand</th>
    <th onclick="srt('casepack','demand')">Demand</th><th onclick="srt('casepack','need')">Need</th>
    <th onclick="srt('casepack','canBuild')">Can Build</th><th>Limiting</th><th onclick="srt('casepack','st')">Status</th>
    <th style="width:40px">Select</th></tr>`;
  rCPT();
}
function rCPT(d){
  if(!d){d=S._c.casepack||[];if(S.cpQ)d=d.filter(r=>r.pn.toLowerCase().includes(S.cpQ.toLowerCase()));}
  S._c.casepackF=d;document.getElementById('casepackCount').textContent=`${d.length} kits`;
  document.getElementById('cpBody').innerHTML=d.map(r=>{
    const stCol=r.need<=0?'var(--green)':r.canBuild>=r.need?'var(--blue)':r.canBuild===0?'var(--red)':'var(--orange)';
    const stTxt=r.need<=0?'OK':r.canBuild>=r.need?`BUILD ${r.need}`:`SHORT ${r.need-r.canBuild}`;
    const sel=S.cpSel===r.pn;
    return`<tr style="${sel?'background:var(--accent-dim)':''}">
      <td>${r.pn}</td><td class="num">${fmt(r.oh)}</td><td class="num">${fmt(r.demand)}</td>
      <td class="num" style="font-weight:600;color:${r.need>0?'var(--accent)':'var(--text-muted)'}">${fmt(r.need)}</td>
      <td class="num" style="color:${r.canBuild===0?'var(--red)':'var(--blue)'}">${fmt(r.canBuild)}</td>
      <td style="font-size:12px;color:var(--text-muted)">${r.limComp}</td>
      <td><span style="font-size:12px;font-weight:600;color:${stCol}">${stTxt}</span></td>
      <td><input type="radio" name="cpsel" ${sel?'checked':''} onchange="S.cpSel='${r.pn.replace(/'/g,"\\'")}'"></td></tr>`;
  }).join('');
}
function printWO(){
  const sel=S.cpSel;if(!sel){alert('Select a product first');return;}
  const kit=(S._c.casepack||[]).find(r=>r.pn===sel);if(!kit){alert('Product not found');return;}
  const today=new Date().toLocaleDateString('en-CA');
  let h=`<html><head><title>Build Work Order - ${sel}</title><style>
    body{font-family:Arial,sans-serif;font-size:12px;padding:20px}
    table{border-collapse:collapse;width:100%;margin:8px 0} th,td{border:1px solid #ccc;padding:6px 10px;text-align:left}
    th{background:#f0f0f0} .num{text-align:right} h1{font-size:18px;margin:0} h2{font-size:14px;margin:16px 0 4px;border-bottom:1px solid #000}
    .sig-row td{border:none;padding:8px 0;border-bottom:1px solid #ccc}
    </style></head><body>`;
  h+=`<h1>KANEL INC.</h1><h1>BUILD WORK ORDER</h1><br>`;
  h+=`<table style="border:none;width:auto"><tr><td style="border:none"><b>Work Order #:</b></td><td style="border:none;border-bottom:1px solid #000;width:150px"></td>
      <td style="border:none;padding-left:40px"><b>Date:</b></td><td style="border:none">${today}</td></tr></table>`;
  h+=`<h2>PRODUCT INFO</h2>`;
  h+=`<table><tr><td><b>Product:</b></td><td>${sel}</td></tr></table>`;
  h+=`<h2>BUILD QUANTITY</h2>`;
  h+=`<table><tr><th>On Hand</th><th>Need to Build</th><th>Actually Built</th><th>Difference</th></tr>
      <tr><td class="num">${kit.oh}</td><td class="num">${kit.need}</td><td></td><td></td></tr></table>`;
  h+=`<h2>COMPONENTS</h2>`;
  h+=`<table><tr><th>Component</th><th>Qty Each</th><th>Total Needed (x${kit.need})</th><th>Available</th><th>Picked &#9744;</th></tr>`;
  (kit.comps||[]).forEach(c=>{
    h+=`<tr><td>${c.name}</td><td class="num">${c.qtyPer}</td><td class="num">${Math.ceil(c.qtyPer*kit.need)}</td><td class="num">${c.available}</td><td></td></tr>`;
  });
  h+=`</table>`;
  h+=`<h2>FISHBOWL CONFIRMATION</h2>`;
  h+=`<table style="border:none"><tr><td style="border:none"><b>Completed in Fishbowl:</b></td><td style="border:none">&#9744; YES</td>
      <td style="border:none;padding-left:40px"><b>Transaction #:</b></td><td style="border:none;border-bottom:1px solid #000;width:150px"></td></tr></table>`;
  h+=`<h2>SIGN-OFF</h2>`;
  h+=`<table><tr><th>Role</th><th>Name</th><th>Initials</th><th>Date</th></tr>
      <tr><td>Built by:</td><td></td><td></td><td></td></tr>
      <tr><td>Checked:</td><td></td><td></td><td></td></tr>
      <tr><td>Fishbowl:</td><td></td><td></td><td></td></tr></table>`;
  h+=`<h2>NOTES</h2><div style="border:1px solid #ccc;height:60px;margin-top:4px"></div>`;
  h+=`</body></html>`;
  const w=window.open('','_blank');w.document.write(h);w.document.close();w.print();
}

// ======== AXIA PRODUCTION (monthly, MOQ, stockout) ========
function calcAX(){
  const boms=S.data.boms||[],inv=S.data.inventory||[],fc=S.forecast||{},fm=S.fm||{},ml=S.mL||[];
  const iL={};inv.forEach(i=>{iL[i.part_number]={oh:i.on_hand_qty||0,av:i.available_qty!==undefined?i.available_qty:i.on_hand_qty||0};});
  const bomByFG={};boms.forEach(b=>{if(!bomByFG[b.finished_good])bomByFG[b.finished_good]=[];bomByFG[b.finished_good].push(b);});
  const kit=/case pack|collection|duo|kit|trio|gift box|edit |shaken|holiday spirit|bright|bring|bonjour|bbq duo|smoke|roasted & raw|top 5|sapio|voyager|mineral|spice lover|family fave|best seller|full spice|traveler/i;
  const axia=/tube|bulk|label/i;
  const bm=S.axiaBM||3;
  const results=[];

  Object.entries(bomByFG).forEach(([fg,comps])=>{
    if(kit.test(fg))return;if(!inc(fg))return;
    if(!comps.some(c=>axia.test(c.component)))return;
    let ffc=fc[fg]||0;if(ffc<=0)return;
    // Add case pack demand
    let totalAnnual=ffc;
    Object.entries(bomByFG).forEach(([cpFG,cpC])=>{
      if(!cpFG.includes('Case Pack'))return;const cpF=fc[cpFG]||0;if(cpF<=0)return;
      cpC.forEach(c=>{if(c.component===fg)totalAnnual+=c.qty_per*cpF;});
    });
    const fgm=fm[fg]||[];
    const moArr=ml.map((m,i)=>Math.round(fgm[i]||totalAnnual/12));
    const i=iL[fg]||{oh:0,av:0};
    const wkD=totalAnnual/52;const woh=wkD>0?i.av/wkD:999;
    // Stockout month
    let soM='--';let run=i.av;
    for(let x=0;x<12;x++){run-=moArr[x]||totalAnnual/12;if(run<=0){soM=ml[x]?ml[x].substring(0,3):'M'+(x+1);break;}}
    // Suggested qty for bm months, rounded to MOQ
    const demPeriod=moArr.slice(0,bm).reduce((s,v)=>s+v,0);
    const rawNeed=Math.max(0,demPeriod-i.av);
    const moq=MOQ[fg]||1000;
    const moqQty=rawNeed>0?Math.ceil(rawNeed/moq)*moq:0;
    // Monthly projection
    const proj=[];let p=i.av;
    for(let x=0;x<ml.length;x++){p-=moArr[x]||0;proj.push(Math.round(p));}
    let st;if(i.av===0)st='oos';else if(woh<4)st='critical';else if(woh<8)st='atrisk';else if(woh<=16)st='healthy';else st='excess';
    results.push({pn:fg,cat:getCat(fg),oh:i.oh,av:i.av,annual:Math.round(totalAnnual),wkD:Math.round(wkD*10)/10,
      woh:Math.round(woh*10)/10,soM,rawNeed:Math.round(rawNeed),moqQty,moq,moArr,proj,st});
  });
  return results.sort((a,b)=>a.woh-b.woh);
}
function rAX(){
  const d=calcAX();S._c.axia=d;S._c.axiaF=d;
  const ml=S.mL||[];
  const c={oos:0,critical:0,atrisk:0,healthy:0,excess:0};d.forEach(r=>{if(c[r.st]!==undefined)c[r.st]++;});
  const tot=d.reduce((s,r)=>s+r.moqQty,0);
  document.getElementById('axiaCards').innerHTML=`
    <div class="card"><div class="card-label">Axia SKUs</div><div class="card-value">${d.length}</div></div>
    <div class="card"><div class="card-label">Need Production</div><div class="card-value red">${c.oos+c.critical+c.atrisk}</div></div>
    <div class="card"><div class="card-label">Healthy</div><div class="card-value blue">${c.healthy}</div></div>
    <div class="card"><div class="card-label">Total MO Units</div><div class="card-value">${fmt(tot)}</div></div>`;
  document.getElementById('axiaFilters').innerHTML=`
    <input type="text" class="search-input" placeholder="Search SKUs..." oninput="S.axQ=this.value;rAXT()">
    <label style="color:var(--text-muted);font-size:13px;margin-left:12px">Build for
    <select class="hs" onchange="S.axiaBM=parseInt(this.value);rAX()">${[1,2,3,4,5,6].map(n=>`<option value="${n}" ${n===S.axiaBM?'selected':''}>${n} mo</option>`).join('')}</select>
    (MOQ from settings)</label>`;
  document.getElementById('axiaHead').innerHTML=`<tr>
    <th onclick="srt('axia','pn')">SKU</th><th onclick="srt('axia','cat')">Category</th><th onclick="srt('axia','av')">Avail</th><th onclick="srt('axia','woh')">WOH</th><th onclick="srt('axia','soM')">Stockout</th>
    ${ml.map(m=>`<th style="font-size:10px">${m.substring(0,3)}</th>`).join('')}
    <th onclick="srt('axia','rawNeed')">Raw Need</th><th onclick="srt('axia','moqQty')">MO Qty</th><th>MOQ</th><th onclick="srt('axia','st')">Status</th></tr>`;
  rAXT();
}
function rAXT(d){
  if(!d){d=S._c.axia||[];if(S.axQ)d=d.filter(r=>r.pn.toLowerCase().includes(S.axQ.toLowerCase()));}
  S._c.axiaF=d;document.getElementById('axiaCount').textContent=`${d.length} SKUs`;
  document.getElementById('axiaBody').innerHTML=d.map(r=>`<tr>
    <td>${r.pn}</td><td style="font-size:11px;color:var(--text-muted)">${r.cat}</td>
    <td class="num">${fmt(r.av)}</td><td class="num" style="font-weight:600">${r.woh>=999?'--':fmt(r.woh,1)}</td>
    <td style="color:${r.soM!=='--'?'var(--red)':'var(--text-muted)'}">${r.soM}</td>
    ${(r.proj||[]).map(v=>`<td class="num" style="font-size:11px;color:${v<=0?'var(--red)':v<500?'var(--orange)':'var(--text-muted)'}">${fmt(v)}</td>`).join('')}
    <td class="num">${fmt(r.rawNeed)}</td>
    <td class="num" style="font-weight:600;color:${r.moqQty>0?'var(--accent)':'var(--text-muted)'}">${fmt(r.moqQty)}</td>
    <td class="num" style="font-size:11px;color:var(--text-muted)">${fmt(r.moq)}</td>
    <td>${bdg(r.st)}</td></tr>`).join('');
}

// ======== OPEN POs (grouped by PO#, expandable) ========
function rPO(){
  const pos=S.data.open_pos||[];
  // Group by PO number
  const groups={};pos.forEach(p=>{
    const k=p.po_num;if(!groups[k])groups[k]={po:k,vendor:p.vendor,status:p.status,items:[],totalQty:0};
    groups[k].items.push(p);groups[k].totalQty+=p.qty_remaining||0;
    // Fix date
    if(p.expected_date){const d=new Date(p.expected_date);if(!isNaN(d))p._date=d.toLocaleDateString('en-CA');else p._date='--';}else p._date='--';
  });
  let gArr=Object.values(groups);
  if(S.poQ){const q=S.poQ.toLowerCase();gArr=gArr.filter(g=>g.items.some(p=>(g.po+g.vendor+p.part).toLowerCase().includes(q)));}
  S._c.posF=gArr;
  const vendors=new Set(pos.map(p=>p.vendor));
  document.getElementById('poCards').innerHTML=`
    <div class="card"><div class="card-label">Open POs</div><div class="card-value">${Object.keys(groups).length}</div></div>
    <div class="card"><div class="card-label">Line Items</div><div class="card-value">${pos.length}</div></div>
    <div class="card"><div class="card-label">Vendors</div><div class="card-value">${vendors.size}</div></div>`;
  document.getElementById('poCount').textContent=`${gArr.length} POs`;
  rPOT(gArr);
}
function rPOT(d){
  if(!d)d=S._c.posF||[];
  let html='';
  d.forEach(g=>{
    html+=`<tr class="po-group" onclick="this.classList.toggle('open');this.parentElement.querySelectorAll('.pd-${g.po}').forEach(r=>r.classList.toggle('open'))">
      <td style="color:var(--accent)">PO #${g.po} - ${g.vendor}</td><td>${g.items.length} items</td>
      <td class="num">${fmt(g.totalQty)}</td><td></td>
      <td><span class="badge ${g.status==='Issued'?'badge-healthy':'badge-atrisk'}">${g.status}</span></td></tr>`;
    g.items.forEach(p=>{
      html+=`<tr class="po-detail pd-${g.po}"><td></td><td>${p.part}</td>
        <td class="num">${fmt(p.qty_remaining)}</td><td>${p._date||'--'}</td>
        <td><span class="badge ${p.status==='Issued'?'badge-healthy':'badge-atrisk'}">${p.status}</span></td></tr>`;
    });
  });
  document.getElementById('poBody').innerHTML=html;
}

// ======== BOMs ========
function rBOM(){
  let d=(S.data.boms||[]).filter(b=>inc(b.finished_good));
  if(S.bomQ){const q=S.bomQ.toLowerCase();d=d.filter(r=>(r.finished_good+r.component).toLowerCase().includes(q));}
  S._c.bomsF=d;rBOMT(d);
}
function rBOMT(d){
  if(!d)d=S._c.bomsF||[];
  document.getElementById('bomCount').textContent=`${d.length} rows`;
  document.getElementById('bomBody').innerHTML=d.map(r=>`<tr><td>${r.finished_good}</td><td>${r.component}</td><td class="num">${r.qty_per}</td><td>${r.uom}</td></tr>`).join('');
}

// ======== MANAGE ITEMS ========
function rManage(){
  const inv=S.data?S.data.inventory||[]:[];
  const q=(document.getElementById('manageSearch')||{}).value||'';
  const f=(document.getElementById('manageFilter')||{}).value||'all';
  let d=inv.slice();
  if(q)d=d.filter(r=>r.part_number.toLowerCase().includes(q.toLowerCase()));
  if(f==='included')d=d.filter(r=>inc(r.part_number));
  else if(f==='excluded')d=d.filter(r=>!inc(r.part_number));
  else if(f==='fg')d=d.filter(r=>r.item_class==='FG');
  else if(f==='rm')d=d.filter(r=>r.item_class==='RM');
  document.getElementById('manageCount').textContent=`${d.length} items (${inv.filter(i=>!inc(i.part_number)).length} excluded)`;
  document.getElementById('manageBody').innerHTML=d.map(r=>{
    const ex=!inc(r.part_number);
    return`<tr style="${ex?'opacity:0.5':''}"><td><input type="checkbox" ${!ex?'checked':''} onchange="toggleItem('${r.part_number.replace(/'/g,"\\'")}',this.checked)"></td>
    <td>${r.part_number}</td><td style="font-size:11px;color:var(--text-muted)">${r.item_class}</td><td class="num">${fmt(r.on_hand_qty)}</td></tr>`;
  }).join('');
}
function toggleItem(pn,included){
  if(included)delete S.excluded[pn];else S.excluded[pn]=true;
  localStorage.setItem('kh-excl',JSON.stringify(S.excluded));
  rManage();
}
function autoExclude(){
  const inv=S.data?S.data.inventory||[]:[];
  let count=0;
  inv.forEach(i=>{
    const n=i.part_number;
    if(AUTO_EXCL.some(p=>n.includes(p))){if(!S.excluded[n]){S.excluded[n]=true;count++;}}
  });
  localStorage.setItem('kh-excl',JSON.stringify(S.excluded));
  alert(`Auto-excluded ${count} items. Review in list below.`);
  rManage();renderAll();
}

// ======== CSV EXPORT ========
function xcsv(tab){
  let rows=[],fn='';const ml=S.mL||[];
  if(tab==='woh'){
    rows=[['Product','Category','On Hand','Committed','Available','Wkly Fcst','DOH','WOH','MOH','Status']];
    (S._c.wohF||[]).forEach(r=>rows.push([r.pn,r.cat,r.oh,r.cm,r.av,r.wf||'',r.doh||'',r.woh||'',r.moh||'',sLbl(r.st)]));fn='Kanel_WOH.csv';
  }else if(tab==='rmdemand'){
    rows=[['Material','Category','UOM',...ml,'TOTAL','OH','Open PO','Net Need','MOS','Status']];
    (S._c.rmdemandF||[]).forEach(r=>rows.push([r.cp,r.rmCat,r.uom,...(r.mo||[]).map(v=>Math.round(v)),Math.round(r.annual),r.oh,r.po,r.net,r.mos,sLbl(r.st)]));fn='Kanel_RM_Demand.csv';
  }else if(tab==='casepack'){
    rows=[['Product','On Hand','Demand','Need','Can Build','Limiting','Status']];
    (S._c.casepackF||[]).forEach(r=>rows.push([r.pn,r.oh,r.demand,r.need,r.canBuild,r.limComp,sLbl(r.st)]));fn='Kanel_CasePack.csv';
  }else if(tab==='axia'){
    rows=[['SKU','Category','Available','WOH','Stockout',...ml.map(m=>m+' Proj'),'Raw Need','MO Qty','MOQ','Status']];
    (S._c.axiaF||[]).forEach(r=>rows.push([r.pn,r.cat,r.av,r.woh,r.soM,...(r.proj||[]),r.rawNeed,r.moqQty,r.moq,sLbl(r.st)]));fn='Kanel_Axia.csv';
  }else if(tab==='pos'){
    rows=[['PO#','Vendor','Part','Qty Remaining','Expected','Status']];
    (S.data.open_pos||[]).forEach(r=>{const d=r.expected_date?new Date(r.expected_date):null;rows.push([r.po_num,r.vendor,r.part,r.qty_remaining,d&&!isNaN(d)?d.toLocaleDateString('en-CA'):'',r.status]);});fn='Kanel_OpenPOs.csv';
  }else if(tab==='boms'){
    rows=[['Finished Good','Component','Qty Per','UOM']];(S._c.bomsF||[]).forEach(r=>rows.push([r.finished_good,r.component,r.qty_per,r.uom]));fn='Kanel_BOMs.csv';
  }
  const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn;a.click();
}

// ======== EXPORT ALL XLSX ========
async function exportAllXLSX(){
  if(!window.XLSX){const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';document.head.appendChild(s);await new Promise(r=>s.onload=r);}
  const wb=XLSX.utils.book_new();const ml=S.mL||[];
  // WOH
  const w=[['Product','Category','On Hand','Committed','Available','Wkly Fcst','DOH','WOH','MOH','Status']];
  (S._c.woh||[]).forEach(r=>w.push([r.pn,r.cat,r.oh,r.cm,r.av,r.wf||'',r.doh||'',r.woh||'',r.moh||'',sLbl(r.st)]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(w),'Weeks on Hand');
  // RM Demand
  const rm=[['Material','Category','UOM',...ml,'TOTAL','OH (inv)','Open PO','Net Need','MOS','Status']];
  (S._c.rmdemand||[]).forEach(r=>rm.push([r.cp,r.rmCat,r.uom,...(r.mo||[]).map(v=>Math.round(v)),Math.round(r.annual),r.oh,r.po,r.net,r.mos,sLbl(r.st)]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rm),'RM Demand');
  // Case Pack
  const cp=[['Product','On Hand','Demand','Need to Build','Can Build','Limiting Component','Status']];
  (S._c.casepack||[]).forEach(r=>cp.push([r.pn,r.oh,r.demand,r.need,r.canBuild,r.limComp,sLbl(r.st)]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(cp),'Case Pack Builder');
  // Axia
  const ax=[['SKU','Category','Available','WOH','Stockout',...ml.map(m=>m+' Proj'),'Raw Need','MO Qty (MOQ)','Status']];
  (S._c.axia||[]).forEach(r=>ax.push([r.pn,r.cat,r.av,r.woh,r.soM,...(r.proj||[]),r.rawNeed,r.moqQty,sLbl(r.st)]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(ax),'Axia Production');
  // Open POs
  const po=[['PO#','Vendor','Part','Qty Remaining','Expected','Status']];
  (S.data.open_pos||[]).forEach(r=>{const d=r.expected_date?new Date(r.expected_date):null;po.push([r.po_num,r.vendor,r.part,r.qty_remaining,d&&!isNaN(d)?d.toLocaleDateString('en-CA'):'',r.status]);});
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(po),'Open POs');
  XLSX.writeFile(wb,`Kanel_Hub_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ======== RENDER ALL ========
function renderAll(){if(!S.data)return;rWOH();rRMD();rCP();rAX();rPO();rBOM();}

// ======== CONNECTION ========
async function saveConfig(){
  const url=document.getElementById('setupUrl').value.trim().replace(/\/$/,'');
  const err=document.getElementById('setupError');
  if(!url){err.textContent='URL required';err.style.display='block';return;}
  err.textContent='Connecting...';err.style.display='block';err.style.color='var(--text-muted)';
  try{
    const r=await fetch(`${url}/api/health`);if(!r.ok)throw new Error(`HTTP ${r.status}`);
    const d=await r.json();if(d.status!=='ok')throw new Error('Bad response');
    S.config={url};localStorage.setItem('kh-cfg',JSON.stringify(S.config));
    document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');
    refreshData();
  }catch(e){err.style.color='var(--red)';err.textContent=`Failed: ${e.message}. Is the proxy running?`;}
}
async function refreshData(){
  const btn=document.getElementById('refreshBtn');btn.disabled=true;
  btn.innerHTML='<div class="loading-spinner" style="width:16px;height:16px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px"></div>Loading...';
  try{
    const r=await fetch(`${S.config.url}/api/woh`);if(!r.ok)throw new Error(`HTTP ${r.status}`);
    S.data=await r.json();
    document.getElementById('lastUpdated').textContent='Updated '+new Date().toLocaleString('en-CA',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    renderAll();
  }catch(e){alert('Failed: '+e.message);}
  btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>Refresh';
}
function loadConfig(){
  const saved=localStorage.getItem('kh-cfg');
  if(saved){try{
    S.config=JSON.parse(saved);
    document.getElementById('setupScreen').classList.add('hidden');document.getElementById('app').classList.remove('hidden');
    const fc=localStorage.getItem('kh-fc');if(fc)S.forecast=JSON.parse(fc);
    const fm=localStorage.getItem('kh-fm');if(fm)S.fm=JSON.parse(fm);
    const ml=localStorage.getItem('kh-ml');if(ml)S.mL=JSON.parse(ml);
    const ex=localStorage.getItem('kh-excl');if(ex)S.excluded=JSON.parse(ex);
    refreshData();
  }catch(e){localStorage.removeItem('kh-cfg');}}
}
loadConfig();
</script>
</body></html>
